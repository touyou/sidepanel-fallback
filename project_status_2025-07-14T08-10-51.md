# SidepanelFallback プロジェクト状態レポート

## 基本情報
- プロジェクト名: sidepanel-fallback
- バージョン: 1.0.0
- 確認日時: 2025-07-14T08:10:49.966Z

## テスト統計
- テストファイル数: 12
- 総テストケース数: 263

### ファイル別内訳:
- benchmark.test.js: 37 テストケース (9 describe blocks)
- browserInfo.test.js: 8 テストケース (1 describe blocks)
- caching.test.js: 31 テストケース (7 describe blocks)
- dependencyInjection.test.js: 16 テストケース (5 describe blocks)
- e2e.test.js: 31 テストケース (8 describe blocks)
- eventSystem.test.js: 30 テストケース (4 describe blocks)
- index.test.js: 27 テストケース (5 describe blocks)
- integration.test.js: 31 テストケース (8 describe blocks)
- modeStorage.test.js: 6 テストケース (1 describe blocks)
- panelLauncher.test.js: 9 テストケース (3 describe blocks)
- performance.test.js: 28 テストケース (7 describe blocks)
- settingsUI.test.js: 9 テストケース (5 describe blocks)

## テスト実行結果
テスト実行エラー:
Command failed: npm test
PASS test/panelLauncher.test.js
  PanelLauncher
    openPanel
      ✓ opens sidepanel when chrome.sidePanel.open is available in sidepanel mode (4 ms)
      ✓ uses window.open to open popup in window mode (2 ms)
      ✓ falls back to window when chrome.sidePanel is not available in sidepanel mode (4 ms)
      ✓ falls back to window when chrome.sidePanel.open throws error in sidepanel mode (1 ms)
      ✓ returns error when window.open fails
      ✓ returns error for invalid mode (other than sidepanel or window)
    isExtensionContext
      ✓ returns true when chrome.sidePanel API is available (1 ms)
      ✓ returns false when chrome object does not exist
      ✓ returns false when chrome object exists but sidePanel does not

PASS test/modeStorage.test.js
  ModeStorage - localStorage
    ✓ can save browser mode (5 ms)
    ✓ can retrieve saved browser mode
    ✓ returns null for unset browsers
    ✓ throws error for invalid browser name (8 ms)
    ✓ throws error for invalid mode name (1 ms)
    ✓ can use valid mode values

PASS test/dependencyInjection.test.js
  SidepanelFallback - Dependency Injection
    DI Container Integration
      ✓ uses custom container when enableDependencyInjection is true (4 ms)
      ✓ uses default implementations when enableDependencyInjection is false (1 ms)
    Custom Implementation Injection
      ✓ uses custom storage implementation (1 ms)
      ✓ uses custom launcher implementation (1 ms)
      ✓ uses custom settings UI implementation
      ✓ uses custom browser detector implementation (1 ms)
    Mixed DI and Custom Implementations
      ✓ prioritizes custom implementations over DI container
    DI Metadata
      ✓ includes DI information in initialization metadata

PASS test/settingsUI.test.js
  SettingsUI
    renderSettingsPanel
      ✓ generates settings panel HTML (8 ms)
      ✓ generates UI reflecting current settings value (mode) (1 ms)
      ✓ uses default value (sidepanel) when unset
    bindEvents
      ✓ binds callback function for settings changes (1 ms)
      ✓ calls callback when radio button is changed
    createSettingsPanel
      ✓ creates complete settings panel (rendering + event binding)
      ✓ can create panel without callback function (1 ms)
    createRadioGroup
      ✓ creates radio button group (1 ms)
      ✓ sets checked state correctly (1 ms)

PASS test/index.test.js
  SidepanelFallback
    init
      ✓ initializes successfully (3 ms)
      ✓ uses default (auto) when mode is unset during initialization
      ✓ can initialize with custom settings (1 ms)
    openPanel
      ✓ opens panel with configured mode
      ✓ selects mode based on browser in auto mode (1 ms)
      ✓ selects window mode for Firefox in auto mode
      ✓ returns error when openPanel is called before init
      ✓ returns error when openPanel is called without arguments (1 ms)
    withSettingsUI
      ✓ creates settings UI and inserts into container
      ✓ saves to storage when settings are changed (1 ms)
      ✓ returns error when withSettingsUI is called before init
      ✓ returns error when container is not specified
    getCurrentSettings
      ✓ can retrieve current settings (1 ms)
      ✓ returns null when called before init

PASS test/browserInfo.test.js
  getBrowserInfo
    ✓ correctly identifies Chrome user agent
    ✓ can detect Dia browser
    ✓ can detect Firefox
    ✓ can detect Safari
    ✓ can detect Edge
    ✓ returns unknown for unrecognized browsers
    ✓ returns unknown when undefined is passed
    ✓ returns unknown when empty string is passed

FAIL test/e2e.test.js
  End-to-End Tests
    Chrome Extension Environment
      ✕ should work end-to-end in Chrome extension context (22 ms)
      ✕ should handle sidepanel API failure gracefully
    Firefox Web Environment
      ✕ should work end-to-end in Firefox without extension API
      ✕ should persist settings in localStorage (1 ms)
    Safari Web Environment
      ✕ should work end-to-end in Safari
      ✕ should handle Safari popup blocking
    Edge Extension Environment
      ✕ should work end-to-end in Edge with extension API
    Cross-Browser Compatibility
      ✕ should initialize consistently across chrome
      ✕ should initialize consistently across firefox (1 ms)
      ✕ should initialize consistently across safari
      ✕ should initialize consistently across edge (1 ms)
      ✕ should use appropriate panel opening method per browser
    Real-World Usage Scenarios
      ✕ should handle rapid successive panel openings
      ✕ should handle settings changes during panel operations (1 ms)
      ✕ should handle network errors gracefully
      ✕ should maintain performance under repeated initialization
    Error Recovery Scenarios
      ✕ should recover from partial initialization failures (1 ms)
      ✕ should handle corrupted cache gracefully

  ● End-to-End Tests › Chrome Extension Environment › should work end-to-end in Chrome extension context

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:123:26)

  ● End-to-End Tests › Chrome Extension Environment › should handle sidepanel API failure gracefully

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:154:7)

  ● End-to-End Tests › Firefox Web Environment › should work end-to-end in Firefox without extension API

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:176:26)

  ● End-to-End Tests › Firefox Web Environment › should persist settings in localStorage

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:193:7)

  ● End-to-End Tests › Safari Web Environment › should work end-to-end in Safari

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:220:26)

  ● End-to-End Tests › Safari Web Environment › should handle Safari popup blocking

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:234:7)

  ● End-to-End Tests › Edge Extension Environment › should work end-to-end in Edge with extension API

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:253:26)

  ● End-to-End Tests › Cross-Browser Compatibility › should initialize consistently across chrome

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:282:24)

  ● End-to-End Tests › Cross-Browser Compatibility › should initialize consistently across firefox

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:282:24)

  ● End-to-End Tests › Cross-Browser Compatibility › should initialize consistently across safari

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:282:24)

  ● End-to-End Tests › Cross-Browser Compatibility › should initialize consistently across edge

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:282:24)

  ● End-to-End Tests › Cross-Browser Compatibility › should use appropriate panel opening method per browser

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:312:9)

  ● End-to-End Tests › Real-World Usage Scenarios › should handle rapid successive panel openings

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:337:7)

  ● End-to-End Tests › Real-World Usage Scenarios › should handle settings changes during panel operations

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:363:7)

  ● End-to-End Tests › Real-World Usage Scenarios › should handle network errors gracefully

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:393:7)

  ● End-to-End Tests › Real-World Usage Scenarios › should maintain performance under repeated initialization

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:412:9)

  ● End-to-End Tests › Error Recovery Scenarios › should recover from partial initialization failures

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:461:22)

  ● End-to-End Tests › Error Recovery Scenarios › should handle corrupted cache gracefully

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:472:7)

FAIL test/integration.test.js
  Integration Tests
    Complete Initialization Workflow
      ✕ should complete full initialization with all features enabled (7 ms)
      ✕ should handle progressive initialization with specific stages (1 ms)
      ✕ should fallback to standard initialization when progressive init fails
    Panel Opening Workflow
      ✓ should open panel with sidepanel mode for Chrome (1 ms)
      ✕ should fallback to window mode when sidepanel fails (2 ms)
      ✕ should use window mode for Firefox (1 ms)
    Settings UI Integration
      ✕ should create and integrate settings UI (1 ms)
      ✕ should handle settings changes end-to-end (1 ms)
    Performance Features Integration
      ✓ should track performance across full workflow (1 ms)
      ✓ should provide meaningful cache recommendations (1 ms)
    Error Handling Integration
      ✓ should handle initialization errors gracefully
      ✕ should handle panel opening errors gracefully (1 ms)
      ✓ should handle settings UI creation errors gracefully
    Event System Integration
      ✓ should emit events throughout the complete workflow (1 ms)
      ✕ should handle event listener errors gracefully (25 ms)
    Memory Management Integration
      ✓ should not leak memory during repeated operations
      ✓ should cleanup UI cache properly (1 ms)

  ● Integration Tests › Complete Initialization Workflow › should complete full initialization with all features enabled

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      138 |       const result = await fallback.init();
      139 |
    > 140 |       expect(result.success).toBe(true);
          |                              ^
      141 |       expect(result.browser).toBeDefined();
      142 |       expect(result.mode).toBeDefined();
      143 |       expect(fallback.initialized).toBe(true);

      at Object.toBe (test/integration.test.js:140:30)

  ● Integration Tests › Complete Initialization Workflow › should handle progressive initialization with specific stages

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      161 |       });
      162 |
    > 163 |       expect(result.success).toBe(true);
          |                              ^
      164 |       expect(fallback.browser).toBeDefined();
      165 |       expect(fallback.storage).toBeDefined();
      166 |       expect(fallback.launcher).toBeDefined();

      at Object.toBe (test/integration.test.js:163:30)

  ● Integration Tests › Complete Initialization Workflow › should fallback to standard initialization when progressive init fails

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      189 |       });
      190 |
    > 191 |       expect(result.success).toBe(true);
          |                              ^
      192 |       expect(fallback.initialized).toBe(true);
      193 |     });
      194 |   });

      at Object.toBe (test/integration.test.js:191:30)

  ● Integration Tests › Panel Opening Workflow › should fallback to window mode when sidepanel fails

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "/test-panel.html", "_blank", StringContaining "width=400"
    Received: "/test-panel.html", "sidepanel_fallback", "width=400,height=600,scrollbars=yes,resizable=yes"

    Number of calls: 1

      226 |       expect(result.success).toBe(true);
      227 |       expect(result.fallback).toBe(true);
    > 228 |       expect(window.open).toHaveBeenCalledWith(
          |                           ^
      229 |         '/test-panel.html',
      230 |         '_blank',
      231 |         expect.stringContaining('width=400')

      at Object.toHaveBeenCalledWith (test/integration.test.js:228:27)

  ● Integration Tests › Panel Opening Workflow › should use window mode for Firefox

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "/test-panel.html", "_blank", StringContaining "width=400"
    Received: "/test-panel.html", "sidepanel_fallback", "width=400,height=600,scrollbars=yes,resizable=yes"

    Number of calls: 1

      241 |
      242 |       expect(result.success).toBe(true);
    > 243 |       expect(window.open).toHaveBeenCalledWith(
          |                           ^
      244 |         '/test-panel.html',
      245 |         '_blank',
      246 |         expect.stringContaining('width=400')

      at Object.toHaveBeenCalledWith (test/integration.test.js:243:27)

  ● Integration Tests › Settings UI Integration › should create and integrate settings UI

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      261 |       const result = await fallback.withSettingsUI(container);
      262 |
    > 263 |       expect(result.success).toBe(true);
          |                              ^
      264 |       expect(container.children.length).toBeGreaterThan(0);
      265 |
      266 |       // Verify settings panel was created

      at Object.toBe (test/integration.test.js:263:30)

  ● Integration Tests › Settings UI Integration › should handle settings changes end-to-end

    ReferenceError: CustomEvent is not defined

      278 |       // Mock the settings change by directly calling the change handler
      279 |       // (In real integration, this would be triggered by user interaction)
    > 280 |       const _settingsChangeEvent = new CustomEvent('change', {
          |                                    ^
      281 |         detail: { mode: newMode }
      282 |       });
      283 |

      at Object.<anonymous> (test/integration.test.js:280:36)

  ● Integration Tests › Error Handling Integration › should handle panel opening errors gracefully

    expect(received).toContain(expected) // indexOf

    Expected substring: "Failed to open panel"
    Received string:    "Failed to open popup window"

      382 |       expect(result.success).toBe(false);
      383 |       expect(result.error).toBeDefined();
    > 384 |       expect(result.error).toContain('Failed to open panel');
          |                            ^
      385 |     });
      386 |
      387 |     it('should handle settings UI creation errors gracefully', async () => {

      at Object.toContain (test/integration.test.js:384:28)

  ● Integration Tests › Event System Integration › should handle event listener errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      450 |       // This should not break the panel opening
      451 |       const result = await fallback.openPanel('/test-panel.html');
    > 452 |       expect(result.success).toBe(true);
          |                              ^
      453 |     });
      454 |   });
      455 |

      at Object.toBe (test/integration.test.js:452:30)

FAIL test/benchmark.test.js
  Performance Benchmark Tests
    Initialization Performance
      ✕ should initialize within acceptable time limits (22 ms)
      ✕ should show improved performance with caching enabled (8 ms)
      ✕ should show progressive initialization benefits for large configurations (1 ms)
    Panel Opening Performance
      ✕ should open panels within acceptable time limits (1 ms)
      ✕ should handle concurrent panel openings efficiently
      ✕ should show consistent performance across repeated operations (1 ms)
    Memory Usage Performance
      ✕ should not leak memory during repeated operations
      ✕ should manage cache size effectively (1 ms)
    Storage Performance
      ✕ should batch storage operations efficiently (1 ms)
      ✕ should optimize storage recommendations
    Lazy Loading Performance
      ✕ should show benefits of lazy loading for large configurations
      ✕ should preload components efficiently (1 ms)
    Event System Performance
      ✕ should handle many event listeners efficiently
      ✕ should clean up event listeners to prevent memory leaks
    Performance Monitoring Overhead
      ✕ should have minimal overhead when performance tracking is enabled (1 ms)
      ✕ should provide useful performance insights
    Scalability Tests
      ✕ should handle increasing load gracefully

  ● Performance Benchmark Tests › Initialization Performance › should initialize within acceptable time limits

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at test/benchmark.test.js:98:9
      at measureTime (test/benchmark.test.js:60:3)
      at Object.<anonymous> (test/benchmark.test.js:93:20)

  ● Performance Benchmark Tests › Initialization Performance › should show improved performance with caching enabled

    Initialization failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at test/benchmark.test.js:112:9
      at measureTime (test/benchmark.test.js:60:3)
      at Object.<anonymous> (test/benchmark.test.js:107:34)

  ● Performance Benchmark Tests › Initialization Performance › should show progressive initialization benefits for large configurations

    Initialization failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at test/benchmark.test.js:146:9
      at measureTime (test/benchmark.test.js:60:3)
      at Object.<anonymous> (test/benchmark.test.js:138:28)

  ● Performance Benchmark Tests › Panel Opening Performance › should open panels within acceptable time limits

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:171:7)

  ● Performance Benchmark Tests › Panel Opening Performance › should handle concurrent panel openings efficiently

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:171:7)

  ● Performance Benchmark Tests › Panel Opening Performance › should show consistent performance across repeated operations

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:171:7)

  ● Performance Benchmark Tests › Memory Usage Performance › should not leak memory during repeated operations

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:231:7)

  ● Performance Benchmark Tests › Memory Usage Performance › should manage cache size effectively

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:260:7)

  ● Performance Benchmark Tests › Storage Performance › should batch storage operations efficiently

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:286:7)

  ● Performance Benchmark Tests › Storage Performance › should optimize storage recommendations

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:286:7)

  ● Performance Benchmark Tests › Lazy Loading Performance › should show benefits of lazy loading for large configurations

    Initialization failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at test/benchmark.test.js:339:9
      at measureTime (test/benchmark.test.js:60:3)
      at Object.<anonymous> (test/benchmark.test.js:334:31)

  ● Performance Benchmark Tests › Lazy Loading Performance › should preload components efficiently

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:360:7)

  ● Performance Benchmark Tests › Event System Performance › should handle many event listeners efficiently

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:378:7)

  ● Performance Benchmark Tests › Event System Performance › should clean up event listeners to prevent memory leaks

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:378:7)

  ● Performance Benchmark Tests › Performance Monitoring Overhead › should have minimal overhead when performance tracking is enabled

    Initialization failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at test/benchmark.test.js:441:9
      at measureTime (test/benchmark.test.js:60:3)
      at Object.<anonymous> (test/benchmark.test.js:435:35)

  ● Performance Benchmark Tests › Performance Monitoring Overhead › should provide useful performance insights

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:468:7)

  ● Performance Benchmark Tests › Scalability Tests › should handle increasing load gracefully

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:496:9)

PASS test/eventSystem.test.js
  Event System
    EventEmitter
      ✓ should implement the IEventEmitter interface (283 ms)
      ✓ should register and call event listeners
      ✓ should support multiple listeners for the same event
      ✓ should support one-time listeners
      ✓ should remove event listeners
      ✓ should return unsubscribe function from on()
      ✓ should handle listener errors gracefully (1 ms)
      ✓ should track listener count
      ✓ should warn about memory leaks
      ✓ should manage max listeners setting (1 ms)
    SidepanelFallback Event Integration
      ✓ should emit initialization events (2 ms)
      ✓ should emit panel operation events (1 ms)
      ✓ should emit settings change events (8 ms)
      ✓ should provide event helper methods (1 ms)
      ✓ should emit debug events
      ✓ should expose event constants (1 ms)
      ✓ should handle event system errors gracefully (15 ms)
    Event Helper Functions
      ✓ should create debug events with proper structure
      ✓ should create error events with proper structure

PASS test/performance.test.js
  Performance and Lazy Loading
    PerformanceTimer
      ✓ should track operation duration (280 ms)
    LazyLoader
      ✓ should load and cache components (1 ms)
      ✓ should handle concurrent loading
      ✓ should handle loading errors (7 ms)
      ✓ should preload components (14 ms)
      ✓ should provide cache statistics
    ProgressiveInitializer
      ✓ should define and run stages in correct order
      ✓ should handle stage failures (1 ms)
      ✓ should handle optional stage failures (2 ms)
      ✓ should handle stage timeouts (51 ms)
      ✓ should provide status information
    MemoryTracker
      ✓ should take memory snapshots
      ✓ should calculate memory diffs
    SidepanelFallback Performance Integration
      ✓ should support performance tracking (1 ms)
      ✓ should support lazy loading
      ✓ should support progressive initialization (1 ms)
      ✓ should support component preloading
      ✓ should support cache clearing (1 ms)
      ✓ should handle initialization with specific stages
      ✓ should fallback to standard init when progressive init is disabled
    createModuleLoader
      ✓ should create a module loader function

PASS test/caching.test.js
  Caching and Storage Optimization
    BrowserDetectionCache
      ✓ should cache browser detection results (284 ms)
      ✓ should respect cache size limit (1 ms)
      ✓ should provide accurate statistics
    BatchedStorage
      ✓ should batch set operations (151 ms)
      ✓ should handle immediate flush (1 ms)
      ✓ should return pending values for gets
      ✓ should provide batch statistics
      ✓ should fallback to individual operations if batch methods unavailable (21 ms)
    UIComponentCache
      ✓ should cache UI components
      ✓ should expire old entries (152 ms)
      ✓ should respect cache size limit with LRU eviction
      ✓ should provide accurate statistics
      ✓ should cleanup expired entries (152 ms)
    StorageOptimizer
      ✓ should record storage operations
      ✓ should provide caching recommendations for frequent keys (1 ms)
      ✓ should provide batching recommendations for high write volume
      ✓ should provide performance recommendations for slow operations
    SidepanelFallback Caching Integration
      ✓ should support caching features (1 ms)
      ✓ should use browser detection cache (1 ms)
      ✓ should support storage optimization
      ✓ should support UI cache cleanup
      ✓ should provide cache recommendations
      ✓ should support selective cache clearing
    createBatchedStorage
      ✓ should create a batched storage wrapper

Test Suites: 3 failed, 9 passed, 12 total
Tests:       44 failed, 126 passed, 170 total
Snapshots:   0 total
Time:        1.429 s, estimated 2 s
Ran all test suites.


> sidepanel-fallback@1.0.0 test
> jest

  console.error
    Error in event listener for "beforeOpenPanel": Error: Listener error
        at EventEmitter.<anonymous> (/Users/touyou/Developer/Private/sidepanel-fallback/test/integration.test.js:447:15)
        at EventEmitter.apply [as emit] (/Users/touyou/Developer/Private/sidepanel-fallback/src/eventSystem.js:151:18)
        at SidepanelFallback.emit [as openPanel] (/Users/touyou/Developer/Private/sidepanel-fallback/src/index.js:645:23)
        at Object.openPanel (/Users/touyou/Developer/Private/sidepanel-fallback/test/integration.test.js:451:37)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

      153 |         // Don't let listener errors break the emit process
      154 |         // eslint-disable-next-line no-console
    > 155 |         console.error(`Error in event listener for "${eventName}":`, error);
          |                 ^
      156 |       }
      157 |     }
      158 |

      at EventEmitter.error [as emit] (src/eventSystem.js:155:17)
      at SidepanelFallback.emit [as openPanel] (src/index.js:645:23)
      at Object.openPanel (test/integration.test.js:451:37)

  console.warn
    Failed to preload component comp3: Error: Failed
        at Object.<anonymous> (/Users/touyou/Developer/Private/sidepanel-fallback/test/performance.test.js:94:49)
        at Promise.finally.completed (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:1559:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:1499:10)
        at _callCircusTest (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:1009:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at _runTest (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:949:3)
        at _runTestsForDescribeBlock (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:1920:21)
        at jestAdapter (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-runner/build/testWorker.js:272:16)
        at runTest (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-runner/build/testWorker.js:340:7)
        at Object.worker (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-runner/build/testWorker.js:494:12)

      151 |         // Log preload errors but don't fail the batch
      152 |         // eslint-disable-next-line no-console
    > 153 |         console.warn(`Failed to preload component ${key}:`, error);
          |                 ^
      154 |         return null;
      155 |       });
      156 |     });

      at warn (src/performanceUtils.js:153:17)
          at async Promise.allSettled (index 2)
      at LazyLoader.preload (src/performanceUtils.js:158:5)
      at Object.<anonymous> (test/performance.test.js:96:7)

  console.warn
    Optional stage stage2 failed: Error: Optional failed
        at Object.<anonymous> (/Users/touyou/Developer/Private/sidepanel-fallback/test/performance.test.js:170:50)
        at Promise.finally.completed (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:1559:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:1499:10)
        at _callCircusTest (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:1009:40)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at _runTest (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:949:3)
        at _runTestsForDescribeBlock (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/jestAdapterInit.js:1920:21)
        at jestAdapter (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-runner/build/testWorker.js:272:16)
        at runTest (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-runner/build/testWorker.js:340:7)
        at Object.worker (/Users/touyou/Developer/Private/sidepanel-fallback/node_modules/jest-runner/build/testWorker.js:494:12)

      260 |           // Log non-required stage errors but continue
      261 |           // eslint-disable-next-line no-console
    > 262 |           console.warn(`Optional stage ${stage.name} failed:`, error);
          |                   ^
      263 |         }
      264 |       }
      265 |

      at ProgressiveInitializer.warn [as initialize] (src/performanceUtils.js:262:19)
      at Object.<anonymous> (test/performance.test.js:177:22)


PASS test/panelLauncher.test.js
  PanelLauncher
    openPanel
      ✓ opens sidepanel when chrome.sidePanel.open is available in sidepanel mode (4 ms)
      ✓ uses window.open to open popup in window mode (2 ms)
      ✓ falls back to window when chrome.sidePanel is not available in sidepanel mode (4 ms)
      ✓ falls back to window when chrome.sidePanel.open throws error in sidepanel mode (1 ms)
      ✓ returns error when window.open fails
      ✓ returns error for invalid mode (other than sidepanel or window)
    isExtensionContext
      ✓ returns true when chrome.sidePanel API is available (1 ms)
      ✓ returns false when chrome object does not exist
      ✓ returns false when chrome object exists but sidePanel does not

PASS test/modeStorage.test.js
  ModeStorage - localStorage
    ✓ can save browser mode (5 ms)
    ✓ can retrieve saved browser mode
    ✓ returns null for unset browsers
    ✓ throws error for invalid browser name (8 ms)
    ✓ throws error for invalid mode name (1 ms)
    ✓ can use valid mode values

PASS test/dependencyInjection.test.js
  SidepanelFallback - Dependency Injection
    DI Container Integration
      ✓ uses custom container when enableDependencyInjection is true (4 ms)
      ✓ uses default implementations when enableDependencyInjection is false (1 ms)
    Custom Implementation Injection
      ✓ uses custom storage implementation (1 ms)
      ✓ uses custom launcher implementation (1 ms)
      ✓ uses custom settings UI implementation
      ✓ uses custom browser detector implementation (1 ms)
    Mixed DI and Custom Implementations
      ✓ prioritizes custom implementations over DI container
    DI Metadata
      ✓ includes DI information in initialization metadata

PASS test/settingsUI.test.js
  SettingsUI
    renderSettingsPanel
      ✓ generates settings panel HTML (8 ms)
      ✓ generates UI reflecting current settings value (mode) (1 ms)
      ✓ uses default value (sidepanel) when unset
    bindEvents
      ✓ binds callback function for settings changes (1 ms)
      ✓ calls callback when radio button is changed
    createSettingsPanel
      ✓ creates complete settings panel (rendering + event binding)
      ✓ can create panel without callback function (1 ms)
    createRadioGroup
      ✓ creates radio button group (1 ms)
      ✓ sets checked state correctly (1 ms)

PASS test/index.test.js
  SidepanelFallback
    init
      ✓ initializes successfully (3 ms)
      ✓ uses default (auto) when mode is unset during initialization
      ✓ can initialize with custom settings (1 ms)
    openPanel
      ✓ opens panel with configured mode
      ✓ selects mode based on browser in auto mode (1 ms)
      ✓ selects window mode for Firefox in auto mode
      ✓ returns error when openPanel is called before init
      ✓ returns error when openPanel is called without arguments (1 ms)
    withSettingsUI
      ✓ creates settings UI and inserts into container
      ✓ saves to storage when settings are changed (1 ms)
      ✓ returns error when withSettingsUI is called before init
      ✓ returns error when container is not specified
    getCurrentSettings
      ✓ can retrieve current settings (1 ms)
      ✓ returns null when called before init

PASS test/browserInfo.test.js
  getBrowserInfo
    ✓ correctly identifies Chrome user agent
    ✓ can detect Dia browser
    ✓ can detect Firefox
    ✓ can detect Safari
    ✓ can detect Edge
    ✓ returns unknown for unrecognized browsers
    ✓ returns unknown when undefined is passed
    ✓ returns unknown when empty string is passed

FAIL test/e2e.test.js
  End-to-End Tests
    Chrome Extension Environment
      ✕ should work end-to-end in Chrome extension context (22 ms)
      ✕ should handle sidepanel API failure gracefully
    Firefox Web Environment
      ✕ should work end-to-end in Firefox without extension API
      ✕ should persist settings in localStorage (1 ms)
    Safari Web Environment
      ✕ should work end-to-end in Safari
      ✕ should handle Safari popup blocking
    Edge Extension Environment
      ✕ should work end-to-end in Edge with extension API
    Cross-Browser Compatibility
      ✕ should initialize consistently across chrome
      ✕ should initialize consistently across firefox (1 ms)
      ✕ should initialize consistently across safari
      ✕ should initialize consistently across edge (1 ms)
      ✕ should use appropriate panel opening method per browser
    Real-World Usage Scenarios
      ✕ should handle rapid successive panel openings
      ✕ should handle settings changes during panel operations (1 ms)
      ✕ should handle network errors gracefully
      ✕ should maintain performance under repeated initialization
    Error Recovery Scenarios
      ✕ should recover from partial initialization failures (1 ms)
      ✕ should handle corrupted cache gracefully

  ● End-to-End Tests › Chrome Extension Environment › should work end-to-end in Chrome extension context

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:123:26)

  ● End-to-End Tests › Chrome Extension Environment › should handle sidepanel API failure gracefully

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:154:7)

  ● End-to-End Tests › Firefox Web Environment › should work end-to-end in Firefox without extension API

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:176:26)

  ● End-to-End Tests › Firefox Web Environment › should persist settings in localStorage

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:193:7)

  ● End-to-End Tests › Safari Web Environment › should work end-to-end in Safari

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:220:26)

  ● End-to-End Tests › Safari Web Environment › should handle Safari popup blocking

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:234:7)

  ● End-to-End Tests › Edge Extension Environment › should work end-to-end in Edge with extension API

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:253:26)

  ● End-to-End Tests › Cross-Browser Compatibility › should initialize consistently across chrome

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:282:24)

  ● End-to-End Tests › Cross-Browser Compatibility › should initialize consistently across firefox

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:282:24)

  ● End-to-End Tests › Cross-Browser Compatibility › should initialize consistently across safari

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:282:24)

  ● End-to-End Tests › Cross-Browser Compatibility › should initialize consistently across edge

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:282:24)

  ● End-to-End Tests › Cross-Browser Compatibility › should use appropriate panel opening method per browser

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:312:9)

  ● End-to-End Tests › Real-World Usage Scenarios › should handle rapid successive panel openings

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:337:7)

  ● End-to-End Tests › Real-World Usage Scenarios › should handle settings changes during panel operations

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:363:7)

  ● End-to-End Tests › Real-World Usage Scenarios › should handle network errors gracefully

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:393:7)

  ● End-to-End Tests › Real-World Usage Scenarios › should maintain performance under repeated initialization

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:412:9)

  ● End-to-End Tests › Error Recovery Scenarios › should recover from partial initialization failures

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:461:22)

  ● End-to-End Tests › Error Recovery Scenarios › should handle corrupted cache gracefully

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/e2e.test.js:472:7)

FAIL test/integration.test.js
  Integration Tests
    Complete Initialization Workflow
      ✕ should complete full initialization with all features enabled (7 ms)
      ✕ should handle progressive initialization with specific stages (1 ms)
      ✕ should fallback to standard initialization when progressive init fails
    Panel Opening Workflow
      ✓ should open panel with sidepanel mode for Chrome (1 ms)
      ✕ should fallback to window mode when sidepanel fails (2 ms)
      ✕ should use window mode for Firefox (1 ms)
    Settings UI Integration
      ✕ should create and integrate settings UI (1 ms)
      ✕ should handle settings changes end-to-end (1 ms)
    Performance Features Integration
      ✓ should track performance across full workflow (1 ms)
      ✓ should provide meaningful cache recommendations (1 ms)
    Error Handling Integration
      ✓ should handle initialization errors gracefully
      ✕ should handle panel opening errors gracefully (1 ms)
      ✓ should handle settings UI creation errors gracefully
    Event System Integration
      ✓ should emit events throughout the complete workflow (1 ms)
      ✕ should handle event listener errors gracefully (25 ms)
    Memory Management Integration
      ✓ should not leak memory during repeated operations
      ✓ should cleanup UI cache properly (1 ms)

  ● Integration Tests › Complete Initialization Workflow › should complete full initialization with all features enabled

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      138 |       const result = await fallback.init();
      139 |
    > 140 |       expect(result.success).toBe(true);
          |                              ^
      141 |       expect(result.browser).toBeDefined();
      142 |       expect(result.mode).toBeDefined();
      143 |       expect(fallback.initialized).toBe(true);

      at Object.toBe (test/integration.test.js:140:30)

  ● Integration Tests › Complete Initialization Workflow › should handle progressive initialization with specific stages

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      161 |       });
      162 |
    > 163 |       expect(result.success).toBe(true);
          |                              ^
      164 |       expect(fallback.browser).toBeDefined();
      165 |       expect(fallback.storage).toBeDefined();
      166 |       expect(fallback.launcher).toBeDefined();

      at Object.toBe (test/integration.test.js:163:30)

  ● Integration Tests › Complete Initialization Workflow › should fallback to standard initialization when progressive init fails

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      189 |       });
      190 |
    > 191 |       expect(result.success).toBe(true);
          |                              ^
      192 |       expect(fallback.initialized).toBe(true);
      193 |     });
      194 |   });

      at Object.toBe (test/integration.test.js:191:30)

  ● Integration Tests › Panel Opening Workflow › should fallback to window mode when sidepanel fails

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "/test-panel.html", "_blank", StringContaining "width=400"
    Received: "/test-panel.html", "sidepanel_fallback", "width=400,height=600,scrollbars=yes,resizable=yes"

    Number of calls: 1

      226 |       expect(result.success).toBe(true);
      227 |       expect(result.fallback).toBe(true);
    > 228 |       expect(window.open).toHaveBeenCalledWith(
          |                           ^
      229 |         '/test-panel.html',
      230 |         '_blank',
      231 |         expect.stringContaining('width=400')

      at Object.toHaveBeenCalledWith (test/integration.test.js:228:27)

  ● Integration Tests › Panel Opening Workflow › should use window mode for Firefox

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "/test-panel.html", "_blank", StringContaining "width=400"
    Received: "/test-panel.html", "sidepanel_fallback", "width=400,height=600,scrollbars=yes,resizable=yes"

    Number of calls: 1

      241 |
      242 |       expect(result.success).toBe(true);
    > 243 |       expect(window.open).toHaveBeenCalledWith(
          |                           ^
      244 |         '/test-panel.html',
      245 |         '_blank',
      246 |         expect.stringContaining('width=400')

      at Object.toHaveBeenCalledWith (test/integration.test.js:243:27)

  ● Integration Tests › Settings UI Integration › should create and integrate settings UI

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      261 |       const result = await fallback.withSettingsUI(container);
      262 |
    > 263 |       expect(result.success).toBe(true);
          |                              ^
      264 |       expect(container.children.length).toBeGreaterThan(0);
      265 |
      266 |       // Verify settings panel was created

      at Object.toBe (test/integration.test.js:263:30)

  ● Integration Tests › Settings UI Integration › should handle settings changes end-to-end

    ReferenceError: CustomEvent is not defined

      278 |       // Mock the settings change by directly calling the change handler
      279 |       // (In real integration, this would be triggered by user interaction)
    > 280 |       const _settingsChangeEvent = new CustomEvent('change', {
          |                                    ^
      281 |         detail: { mode: newMode }
      282 |       });
      283 |

      at Object.<anonymous> (test/integration.test.js:280:36)

  ● Integration Tests › Error Handling Integration › should handle panel opening errors gracefully

    expect(received).toContain(expected) // indexOf

    Expected substring: "Failed to open panel"
    Received string:    "Failed to open popup window"

      382 |       expect(result.success).toBe(false);
      383 |       expect(result.error).toBeDefined();
    > 384 |       expect(result.error).toContain('Failed to open panel');
          |                            ^
      385 |     });
      386 |
      387 |     it('should handle settings UI creation errors gracefully', async () => {

      at Object.toContain (test/integration.test.js:384:28)

  ● Integration Tests › Event System Integration › should handle event listener errors gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      450 |       // This should not break the panel opening
      451 |       const result = await fallback.openPanel('/test-panel.html');
    > 452 |       expect(result.success).toBe(true);
          |                              ^
      453 |     });
      454 |   });
      455 |

      at Object.toBe (test/integration.test.js:452:30)

FAIL test/benchmark.test.js
  Performance Benchmark Tests
    Initialization Performance
      ✕ should initialize within acceptable time limits (22 ms)
      ✕ should show improved performance with caching enabled (8 ms)
      ✕ should show progressive initialization benefits for large configurations (1 ms)
    Panel Opening Performance
      ✕ should open panels within acceptable time limits (1 ms)
      ✕ should handle concurrent panel openings efficiently
      ✕ should show consistent performance across repeated operations (1 ms)
    Memory Usage Performance
      ✕ should not leak memory during repeated operations
      ✕ should manage cache size effectively (1 ms)
    Storage Performance
      ✕ should batch storage operations efficiently (1 ms)
      ✕ should optimize storage recommendations
    Lazy Loading Performance
      ✕ should show benefits of lazy loading for large configurations
      ✕ should preload components efficiently (1 ms)
    Event System Performance
      ✕ should handle many event listeners efficiently
      ✕ should clean up event listeners to prevent memory leaks
    Performance Monitoring Overhead
      ✕ should have minimal overhead when performance tracking is enabled (1 ms)
      ✕ should provide useful performance insights
    Scalability Tests
      ✕ should handle increasing load gracefully

  ● Performance Benchmark Tests › Initialization Performance › should initialize within acceptable time limits

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at test/benchmark.test.js:98:9
      at measureTime (test/benchmark.test.js:60:3)
      at Object.<anonymous> (test/benchmark.test.js:93:20)

  ● Performance Benchmark Tests › Initialization Performance › should show improved performance with caching enabled

    Initialization failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at test/benchmark.test.js:112:9
      at measureTime (test/benchmark.test.js:60:3)
      at Object.<anonymous> (test/benchmark.test.js:107:34)

  ● Performance Benchmark Tests › Initialization Performance › should show progressive initialization benefits for large configurations

    Initialization failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at test/benchmark.test.js:146:9
      at measureTime (test/benchmark.test.js:60:3)
      at Object.<anonymous> (test/benchmark.test.js:138:28)

  ● Performance Benchmark Tests › Panel Opening Performance › should open panels within acceptable time limits

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:171:7)

  ● Performance Benchmark Tests › Panel Opening Performance › should handle concurrent panel openings efficiently

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:171:7)

  ● Performance Benchmark Tests › Panel Opening Performance › should show consistent performance across repeated operations

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:171:7)

  ● Performance Benchmark Tests › Memory Usage Performance › should not leak memory during repeated operations

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:231:7)

  ● Performance Benchmark Tests › Memory Usage Performance › should manage cache size effectively

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:260:7)

  ● Performance Benchmark Tests › Storage Performance › should batch storage operations efficiently

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:286:7)

  ● Performance Benchmark Tests › Storage Performance › should optimize storage recommendations

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:286:7)

  ● Performance Benchmark Tests › Lazy Loading Performance › should show benefits of lazy loading for large configurations

    Initialization failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at test/benchmark.test.js:339:9
      at measureTime (test/benchmark.test.js:60:3)
      at Object.<anonymous> (test/benchmark.test.js:334:31)

  ● Performance Benchmark Tests › Lazy Loading Performance › should preload components efficiently

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:360:7)

  ● Performance Benchmark Tests › Event System Performance › should handle many event listeners efficiently

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:378:7)

  ● Performance Benchmark Tests › Event System Performance › should clean up event listeners to prevent memory leaks

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:378:7)

  ● Performance Benchmark Tests › Performance Monitoring Overhead › should have minimal overhead when performance tracking is enabled

    Initialization failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at test/benchmark.test.js:441:9
      at measureTime (test/benchmark.test.js:60:3)
      at Object.<anonymous> (test/benchmark.test.js:435:35)

  ● Performance Benchmark Tests › Performance Monitoring Overhead › should provide useful performance insights

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:468:7)

  ● Performance Benchmark Tests › Scalability Tests › should handle increasing load gracefully

    Initialization failed: Progressive initialization failed: Required stage storage failed: localStorage is not defined

      361 |
      362 |       // For init errors, throw the error for backward compatibility
    > 363 |       throw new Error(errorResult.error);
          |             ^
      364 |     }
      365 |   }
      366 |

      at SidepanelFallback.init (src/index.js:363:13)
      at Object.<anonymous> (test/benchmark.test.js:496:9)

PASS test/eventSystem.test.js
  Event System
    EventEmitter
      ✓ should implement the IEventEmitter interface (283 ms)
      ✓ should register and call event listeners
      ✓ should support multiple listeners for the same event
      ✓ should support one-time listeners
      ✓ should remove event listeners
      ✓ should return unsubscribe function from on()
      ✓ should handle listener errors gracefully (1 ms)
      ✓ should track listener count
      ✓ should warn about memory leaks
      ✓ should manage max listeners setting (1 ms)
    SidepanelFallback Event Integration
      ✓ should emit initialization events (2 ms)
      ✓ should emit panel operation events (1 ms)
      ✓ should emit settings change events (8 ms)
      ✓ should provide event helper methods (1 ms)
      ✓ should emit debug events
      ✓ should expose event constants (1 ms)
      ✓ should handle event system errors gracefully (15 ms)
    Event Helper Functions
      ✓ should create debug events with proper structure
      ✓ should create error events with proper structure

PASS test/performance.test.js
  Performance and Lazy Loading
    PerformanceTimer
      ✓ should track operation duration (280 ms)
    LazyLoader
      ✓ should load and cache components (1 ms)
      ✓ should handle concurrent loading
      ✓ should handle loading errors (7 ms)
      ✓ should preload components (14 ms)
      ✓ should provide cache statistics
    ProgressiveInitializer
      ✓ should define and run stages in correct order
      ✓ should handle stage failures (1 ms)
      ✓ should handle optional stage failures (2 ms)
      ✓ should handle stage timeouts (51 ms)
      ✓ should provide status information
    MemoryTracker
      ✓ should take memory snapshots
      ✓ should calculate memory diffs
    SidepanelFallback Performance Integration
      ✓ should support performance tracking (1 ms)
      ✓ should support lazy loading
      ✓ should support progressive initialization (1 ms)
      ✓ should support component preloading
      ✓ should support cache clearing (1 ms)
      ✓ should handle initialization with specific stages
      ✓ should fallback to standard init when progressive init is disabled
    createModuleLoader
      ✓ should create a module loader function

PASS test/caching.test.js
  Caching and Storage Optimization
    BrowserDetectionCache
      ✓ should cache browser detection results (284 ms)
      ✓ should respect cache size limit (1 ms)
      ✓ should provide accurate statistics
    BatchedStorage
      ✓ should batch set operations (151 ms)
      ✓ should handle immediate flush (1 ms)
      ✓ should return pending values for gets
      ✓ should provide batch statistics
      ✓ should fallback to individual operations if batch methods unavailable (21 ms)
    UIComponentCache
      ✓ should cache UI components
      ✓ should expire old entries (152 ms)
      ✓ should respect cache size limit with LRU eviction
      ✓ should provide accurate statistics
      ✓ should cleanup expired entries (152 ms)
    StorageOptimizer
      ✓ should record storage operations
      ✓ should provide caching recommendations for frequent keys (1 ms)
      ✓ should provide batching recommendations for high write volume
      ✓ should provide performance recommendations for slow operations
    SidepanelFallback Caching Integration
      ✓ should support caching features (1 ms)
      ✓ should use browser detection cache (1 ms)
      ✓ should support storage optimization
      ✓ should support UI cache cleanup
      ✓ should provide cache recommendations
      ✓ should support selective cache clearing
    createBatchedStorage
      ✓ should create a batched storage wrapper

Test Suites: 3 failed, 9 passed, 12 total
Tests:       44 failed, 126 passed, 170 total
Snapshots:   0 total
Time:        1.429 s, estimated 2 s
Ran all test suites.


## ファイル構成
CHANGELOG.md, CONTRIBUTING.md, LICENSE, README.md, REFACTORING_PLAN.md, SECURITY.md, babel.config.json, coverage, dist, docs, eslint.config.mjs, node_modules, package-lock.json, package.json, public, scripts, src, test, test_results_20250714_170954.txt, test_status_check.js, vite.config.js
